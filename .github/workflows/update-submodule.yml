name: Update Submodule

on:
  repository_dispatch:
    types: [update-submodule]
  
  workflow_dispatch:
    inputs:
      sha:
        description: 'Nháº­p Commit SHA cá»§a Web (Äá»ƒ trá»‘ng sáº½ láº¥y má»›i nháº¥t cá»§a main)'
        required: false
        type: string

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout Code
      - name: Checkout DevOps Repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.DEVOPS_PAT }} 
          submodules: true
          fetch-depth: 0

      # 2. Update Submodule
      - name: Update Submodule Code
        id: update-submodule
        run: |
          cd web/dorashop
          git fetch origin
          
          # Logic chá»n Commit ID
          if [ -n "${{ github.event.client_payload.sha }}" ]; then
            echo "ðŸ”¥ Mode: Auto Trigger from Web"
            TARGET="${{ github.event.client_payload.sha }}"
            
          elif [ -n "${{ inputs.sha }}" ]; then
            echo "ðŸ‘‹ Mode: Manual Input"
            TARGET="${{ inputs.sha }}"
            
          else
            echo "âš¡ Mode: Manual Default (Latest Main)"
            TARGET="origin/main"
          fi

          echo "Checking out to: $TARGET"
          git checkout $TARGET
          cd ../..
          
          # Export TARGET to GITHUB_OUTPUT for next steps
          echo "target=$TARGET" >> $GITHUB_OUTPUT

      # 3. Commit & Push (Chá»‰ push náº¿u cÃ³ thay Ä‘á»•i)
      - name: Commit and Push
        id: commit-push
        run: |
          git config --global user.name 'actions-user'
          git config --global user.email 'actions-user@noreply.github.com'
          
          if [[ -n $(git status -s) ]]; then
            git add .
            git commit -m "chore: update submodule dorashop to ${{ steps.update-submodule.outputs.target }}"
            git push origin main
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Submodule is already up to date. No changes."
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
      
      # 4. Trigger CI/CD Pipeline manually
      - name: Trigger CI/CD Pipeline
        if: steps.commit-push.outputs.has_changes == 'true'
        run: |
          curl -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.DEVOPS_PAT }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/kenjima3301/NT548-DevOps/actions/workflows/ci-cd-pipeline.yml/dispatches \
            -d '{"ref":"main"}'