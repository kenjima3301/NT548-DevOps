name: Update Submodule

on:
  repository_dispatch:
    types: [update-submodule]
  
  workflow_dispatch:
    inputs:
      sha:
        description: 'Nháº­p Commit SHA cá»§a Web (Äá»ƒ trá»‘ng sáº½ láº¥y má»›i nháº¥t cá»§a main)'
        required: false
        type: string

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout Code
      - name: Checkout DevOps Repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.DEVOPS_PAT }} 
          submodules: true
          fetch-depth: 0

      # 2. Update Submodule
      - name: Update Submodule Code
        id: update
        run: |
          cd web/dorashop
          git fetch origin
          
          # Logic chá»n Commit ID
          if [ -n "${{ github.event.client_payload.sha }}" ]; then
            echo "ðŸ”¥ Mode: Auto Trigger from Web"
            TARGET="${{ github.event.client_payload.sha }}"
            PATHS="${{ github.event.client_payload.paths }}"
            if [ -n "$PATHS" ]; then
              echo "ðŸ“ Changed: $PATHS"
            fi
            
          elif [ -n "${{ inputs.sha }}" ]; then
            echo "ðŸ‘‹ Mode: Manual Input"
            TARGET="${{ inputs.sha }}"
            
          else
            echo "âš¡ Mode: Manual Default (Latest Main)"
            TARGET="origin/main"
          fi

          echo "Checking out to: $TARGET"
          git checkout $TARGET
          
          # Get actual commit hash after checkout
          ACTUAL_SHA=$(git rev-parse HEAD)
          echo "target_sha=$ACTUAL_SHA" >> $GITHUB_OUTPUT
          echo "changed_paths=$PATHS" >> $GITHUB_OUTPUT
          cd ../..

      # 3. Commit & Push (Chá»‰ push náº¿u cÃ³ thay Ä‘á»•i)
      - name: Commit and Push
        id: push
        run: |
          git config --global user.name 'CI/CD Bot'
          git config --global user.email 'ci-cd-bot@users.noreply.github.com'
          
          if [[ -n $(git status -s) ]]; then
            COMMIT_MSG="chore: update submodule to ${{ steps.update.outputs.target_sha }}"
            
            if [[ -n "${{ steps.update.outputs.changed_paths }}" ]]; then
              COMMIT_MSG="$COMMIT_MSG [${{ steps.update.outputs.changed_paths }}]"
            fi
            
            git add .
            git commit -m "$COMMIT_MSG"
            git push origin main
            echo "updated=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Submodule is already up to date. No changes."
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

      # 4. Trigger CI/CD Pipeline with paths info
      - name: Trigger CI/CD Pipeline
        if: steps.push.outputs.updated == 'true' && github.event.client_payload.paths != ''
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.DEVOPS_PAT }}
          repository: kenjima3301/NT548-DevOps
          event-type: run-cicd
          client-payload: '{"sha": "${{ steps.update.outputs.target_sha }}", "paths": "${{ steps.update.outputs.changed_paths }}"}'