name: Update Submodule

on:
  repository_dispatch:
    types: [update-submodule]
  
  workflow_dispatch:
    inputs:
      sha:
        description: 'Nháº­p Commit SHA cá»§a Web (Äá»ƒ trá»‘ng sáº½ láº¥y má»›i nháº¥t cá»§a main)'
        required: false
        type: string
      changed_services:
        description: 'Services Ä‘Ã£ thay Ä‘á»•i (cart, products, hoáº·c cart,products)'
        required: false
        type: string
        default: 'cart,products'
      change_type:
        description: 'Type of change (critical, core, service, frontend, config, normal)'
        required: false
        type: string
        default: 'normal'

jobs:
  sync:
    runs-on: ubuntu-latest
    outputs:
      changed_services: ${{ steps.set-output.outputs.services }}
      change_type: ${{ steps.set-output.outputs.change_type }}
      critical_files: ${{ steps.set-output.outputs.critical_files }}
    steps:
      - name: Checkout DevOps Repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.DEVOPS_PAT }} 
          submodules: true
          fetch-depth: 0

      - name: Display Event Info
        if: github.event_name == 'repository_dispatch'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“¥ Received Update from Submodule"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ”– SHA: ${{ github.event.client_payload.sha }}"
          echo "ðŸ·ï¸  Branch: ${{ github.event.client_payload.branch }}"
          echo "ðŸ“¦ Services: ${{ github.event.client_payload.changed_services }}"
          echo "ðŸ”§ Type: ${{ github.event.client_payload.change_type }}"
          echo "ðŸ”´ Critical: ${{ github.event.client_payload.critical_files }}"
          echo "ðŸ‘¤ Author: ${{ github.event.client_payload.author }}"
          echo "ðŸ’¬ Message: ${{ github.event.client_payload.commit_message }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Update Submodule Code
        run: |
          cd web/dorashop
          git fetch origin
          
          # Logic chá»n Commit ID
          if [ -n "${{ github.event.client_payload.sha }}" ]; then
            echo "ðŸ”¥ Mode: Auto Trigger from Web"
            TARGET="${{ github.event.client_payload.sha }}"
            
          elif [ -n "${{ inputs.sha }}" ]; then
            echo "ðŸ‘‹ Mode: Manual Input"
            TARGET="${{ inputs.sha }}"
            
          else
            echo "âš¡ Mode: Manual Default (Latest Main)"
            TARGET="origin/main"
          fi

          echo "Checking out to: $TARGET"
          git checkout $TARGET
          cd ../..

      - name: Set Output Metadata
        id: set-output
        run: |
          # Get services
          if [ -n "${{ github.event.client_payload.changed_services }}" ]; then
            SERVICES="${{ github.event.client_payload.changed_services }}"
          elif [ -n "${{ inputs.changed_services }}" ]; then
            SERVICES="${{ inputs.changed_services }}"
          else
            SERVICES="all"
          fi
          
          # Get change type
          if [ -n "${{ github.event.client_payload.change_type }}" ]; then
            CHANGE_TYPE="${{ github.event.client_payload.change_type }}"
          elif [ -n "${{ inputs.change_type }}" ]; then
            CHANGE_TYPE="${{ inputs.change_type }}"
          else
            CHANGE_TYPE="normal"
          fi
          
          # Get critical flag
          if [ -n "${{ github.event.client_payload.critical_files }}" ]; then
            CRITICAL="${{ github.event.client_payload.critical_files }}"
          else
            CRITICAL="false"
          fi
          
          echo "services=$SERVICES" >> $GITHUB_OUTPUT
          echo "change_type=$CHANGE_TYPE" >> $GITHUB_OUTPUT
          echo "critical_files=$CRITICAL" >> $GITHUB_OUTPUT
          
          echo "ðŸŽ¯ Pipeline will build: $SERVICES"
          echo "ðŸ”§ Change type: $CHANGE_TYPE"
          echo "ðŸ”´ Critical: $CRITICAL"

      - name: Commit and Push
        run: |
          git config --global user.name 'CI/CD Bot'
          git config --global user.email 'ci-cd-bot@users.noreply.github.com'
          
          if [[ -n $(git status -s) ]]; then
            COMMIT_MSG="chore: update submodule [${{ steps.set-output.outputs.services }}]"
            
            if [[ "${{ steps.set-output.outputs.critical_files }}" == "true" ]]; then
              COMMIT_MSG="$COMMIT_MSG ðŸ”´ CRITICAL"
            fi
            
            git add .
            git commit -m "$COMMIT_MSG"
            git push origin main
          else
            echo "âœ… Submodule is already up to date. No changes."
          fi

  trigger-build:
    runs-on: ubuntu-latest
    needs: sync
    steps:
      - name: Trigger Service CI/CD
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.DEVOPS_PAT }}
          repository: kenjima3301/NT548-DevOps
          event-type: service-build
          client-payload: |
            {
              "changed_services": "${{ needs.sync.outputs.changed_services }}",
              "change_type": "${{ needs.sync.outputs.change_type }}",
              "critical_files": "${{ needs.sync.outputs.critical_files }}"
            }