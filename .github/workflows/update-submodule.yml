name: Update Submodule

on:
  repository_dispatch:
    types: [update-submodule]
  
  workflow_dispatch:
    inputs:
      sha:
        description: 'Nh·∫≠p Commit SHA c·ªßa Web (ƒê·ªÉ tr·ªëng s·∫Ω l·∫•y m·ªõi nh·∫•t c·ªßa main)'
        required: false
        type: string

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout Code
      - name: Checkout DevOps Repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.DEVOPS_PAT }} 
          submodules: true
          fetch-depth: 0

      # 2. Update Submodule
      - name: Update Submodule Code
        run: |
          cd web/dorashop
          git fetch origin
          
          # Logic ch·ªçn Commit ID
          if [ -n "${{ github.event.client_payload.sha }}" ]; then
            echo "üî• Mode: Auto Trigger from Web"
            TARGET="${{ github.event.client_payload.sha }}"
            
          elif [ -n "${{ inputs.sha }}" ]; then
            echo "üëã Mode: Manual Input"
            TARGET="${{ inputs.sha }}"
            
          else
            echo "‚ö° Mode: Manual Default (Latest Main)"
            TARGET="origin/main"
          fi

          echo "Checking out to: $TARGET"
          git checkout $TARGET
          cd ../..

      # 3. Commit & Push (Ch·ªâ push n·∫øu c√≥ thay ƒë·ªïi)
      - name: Commit and Push
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          
          if [[ -n $(git status -s) ]]; then
            git add .
            git commit -m "Update submodule to $TARGET"
            git push origin main
          else
            echo "‚úÖ Submodule is already up to date. No changes."
          fi