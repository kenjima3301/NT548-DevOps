name: Web Service CI/CD

on:
  pull_request:
    branches: [main, test]
    paths:
      - 'web/dorashop/**'
      - 'ci-cd/k8s/**'
      - 'ci-cd/sonarqube/**'
  push:
    branches: [main, test]
    paths:
      - 'web/dorashop/**'
      - 'ci-cd/k8s/**'

jobs:
  test:
    name: Test Web Service
    runs-on: ubuntu-latest
    # Only run tests on PR
    if: github.event_name == 'pull_request'
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: dorashop
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          cd web/dorashop
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-django

      - name: Run Django Tests
        env:
          DJANGO_SETTINGS_MODULE: dorashop.settings
          PYTHONPATH: ${{ github.workspace }}/web/dorashop
          DB_ENGINE: django.db.backends.postgresql
          DB_NAME: dorashop
          DB_USER: postgres
          DB_PASSWORD: postgres
          DB_HOST: localhost
          DB_PORT: 5432
        run: |
          cd web/dorashop
          python manage.py migrate --noinput
          python manage.py collectstatic --noinput
          cd ${{ github.workspace }}
          pytest ci-cd/sonarqube/tests/ \
            -c ci-cd/sonarqube/pytest.ini \
            --cov=web/dorashop \
            --cov-report=xml:coverage.xml \
            --cov-report=term-missing

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        with:
          args: >
            -Dproject.settings=ci-cd/sonarqube/sonar-project.properties
            -Dsonar.projectBaseDir=${{ github.workspace }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  build-push:
    name: Build & Push Image
    needs: test
    # Only run on push to main/develop after tests pass
    if: github.event_name == 'push'
    uses: ./.github/workflows/_reusable-build-push.yml
    with:
      service_name: dorashop
      dockerfile_path: web/dorashop
      context_path: web/dorashop
      ecr_repository: my-web-app
      aws_region: ap-southeast-1
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  update-manifests:
    name: Update GitOps Manifests
    needs: build-push
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Update Kustomize Image
        env:
          IMAGE_TAG: ${{ needs.build-push.outputs.image_tag }}
          ENVIRONMENT: ${{ github.ref == 'refs/heads/main' && 'production' || 'dev' }}
        run: |
          echo "üì¶ Updating $ENVIRONMENT with image tag: $IMAGE_TAG"
          
          cd ci-cd/k8s/overlays/$ENVIRONMENT
          
          # Update image tag
          kustomize edit set image dorashop-web=540649423715.dkr.ecr.ap-southeast-1.amazonaws.com/my-web-app:$IMAGE_TAG
          
          # Configure git
          git config user.name "CI/CD Bot"
          git config user.email "ci-cd-bot@users.noreply.github.com"
          
          # Commit and push
          git add kustomization.yaml
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è  No changes to commit"
          else
            git commit -m "chore(gitops): update $ENVIRONMENT to $IMAGE_TAG [skip ci]"
            git pull --rebase
            git push
            echo "‚úÖ Manifest updated successfully"
          fi
