name: Smart CI/CD Pipeline

on:
  pull_request:
    branches: 
      - main
      - test
    types: [opened, synchronize, reopened]
    paths:
      - 'web/dorashop/**'
      - 'ci-cd/k8s/**'
      - '.github/workflows/**'
  push:
    branches: 
      - main
      - test
    paths:
      - 'web/dorashop'
      - 'ci-cd/k8s/**'
      - '.github/workflows/**'
  workflow_dispatch:

env:
  IMAGE_TAG: ${{ github.sha }}

jobs:
  # Unified detection for both submodule trigger and direct changes
  detect-changes:
    name: Detect Changes & Build Strategy
    runs-on: ubuntu-latest
    outputs:
      source: ${{ steps.detect.outputs.source }}
      web_paths: ${{ steps.strategy.outputs.web_paths }}
      needs_full_test: ${{ steps.strategy.outputs.needs_full_test }}
      needs_light_scan: ${{ steps.strategy.outputs.needs_light_scan }}
      needs_build: ${{ steps.strategy.outputs.needs_build }}
      skip_build: ${{ steps.strategy.outputs.skip_build }}
      environment: ${{ steps.detect.outputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect Change Source & Paths
        id: detect
        run: |
          # Determine environment
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi
          
          # Parse paths from commit message (tá»« update-submodule)
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          echo "ðŸ“ Commit message: $COMMIT_MSG"
          
          if [[ "$COMMIT_MSG" =~ \[paths:([^\]]+)\] ]]; then
            PATHS="${BASH_REMATCH[1]}"
            echo "source=submodule" >> $GITHUB_OUTPUT
            echo "web_paths=$PATHS" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Source: Submodule update"
            echo "ðŸ“ Parsed paths: $PATHS"
            
          # Direct push/PR to DevOps repo (khÃ´ng cÃ³ [paths:...])
          else
            echo "source=direct" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Source: Direct push/PR"
            # Will use changed-files detection below
          fi
          
      - name: Detect Direct Changes (if not from submodule)
        if: steps.detect.outputs.source == 'direct'
        uses: tj-actions/changed-files@v45
        id: changed
        with:
          files_yaml: |
            web_cart:
              - web/dorashop/cart/**
            web_products:
              - web/dorashop/products/**
            web_core:
              - web/dorashop/dorashop/**
              - web/dorashop/requirements.txt
              - web/dorashop/Dockerfile
              - web/dorashop/docker-compose.yml
              - web/dorashop/manage.py
              - web/dorashop/entrypoint.sh
            web_other:
              - web/dorashop/templates/**
              - web/dorashop/static/**
              - web/dorashop/media/**
            k8s:
              - ci-cd/k8s/**
            workflows:
              - .github/workflows/**
      
      - name: Build Strategy Decision
        id: strategy
        run: |
          SOURCE="${{ steps.detect.outputs.source }}"
          K8S_CHANGED="false"
          WF_CHANGED="false"
          
          if [[ "$SOURCE" == "submodule" ]]; then
            PATHS="${{ steps.detect.outputs.web_paths }}"
            echo "ðŸ“ Submodule paths: $PATHS"
          else
            # Build paths string from direct changes
            PATHS=""
            [[ "${{ steps.changed.outputs.web_cart_any_changed }}" == "true" ]] && PATHS="${PATHS}cart "
            [[ "${{ steps.changed.outputs.web_products_any_changed }}" == "true" ]] && PATHS="${PATHS}products "
            [[ "${{ steps.changed.outputs.web_core_any_changed }}" == "true" ]] && PATHS="${PATHS}core "
            [[ "${{ steps.changed.outputs.web_other_any_changed }}" == "true" ]] && PATHS="${PATHS}other "
            PATHS=$(echo "$PATHS" | xargs)
            
            K8S_CHANGED="${{ steps.changed.outputs.k8s_any_changed }}"
            WF_CHANGED="${{ steps.changed.outputs.workflows_any_changed }}"
            
            echo "ðŸ“ Direct changed paths: $PATHS"
            echo "ðŸ“ K8s changed: $K8S_CHANGED"
            echo "ðŸ“ Workflows changed: $WF_CHANGED"
          fi
          
          echo "web_paths=$PATHS" >> $GITHUB_OUTPUT
          
          # Decision logic
          if [[ "$PATHS" =~ (cart|products|core) ]]; then
            echo "needs_full_test=true" >> $GITHUB_OUTPUT
            echo "needs_light_scan=false" >> $GITHUB_OUTPUT
            echo "needs_build=true" >> $GITHUB_OUTPUT
            echo "skip_build=false" >> $GITHUB_OUTPUT
            echo "ðŸŽ¯ Strategy: Full Test + Build + Deploy"
            
          elif [[ "$PATHS" == "other" ]] || [[ "$PATHS" =~ "other" ]]; then
            echo "needs_full_test=false" >> $GITHUB_OUTPUT
            echo "needs_light_scan=true" >> $GITHUB_OUTPUT
            echo "needs_build=true" >> $GITHUB_OUTPUT
            echo "skip_build=false" >> $GITHUB_OUTPUT
            echo "ðŸŽ¯ Strategy: Light Scan + Build + Deploy"
            
          elif [[ "$K8S_CHANGED" == "true" ]] && [[ -z "$PATHS" ]]; then
            echo "needs_full_test=false" >> $GITHUB_OUTPUT
            echo "needs_light_scan=false" >> $GITHUB_OUTPUT
            echo "needs_build=true" >> $GITHUB_OUTPUT
            echo "skip_build=true" >> $GITHUB_OUTPUT
            echo "ðŸŽ¯ Strategy: Deploy Manifest Only (no build)"
            
          elif [[ "$WF_CHANGED" == "true" ]] && [[ -z "$PATHS" ]] && [[ "$K8S_CHANGED" != "true" ]]; then
            echo "needs_full_test=false" >> $GITHUB_OUTPUT
            echo "needs_light_scan=false" >> $GITHUB_OUTPUT
            echo "needs_build=false" >> $GITHUB_OUTPUT
            echo "skip_build=true" >> $GITHUB_OUTPUT
            echo "ðŸŽ¯ Strategy: Skip all (workflow changes only)"
            
          else
            echo "needs_full_test=false" >> $GITHUB_OUTPUT
            echo "needs_light_scan=false" >> $GITHUB_OUTPUT
            echo "needs_build=false" >> $GITHUB_OUTPUT
            echo "skip_build=true" >> $GITHUB_OUTPUT
            echo "ðŸŽ¯ Strategy: Skip all (no relevant changes)"
          fi

  # Full test for cart/products/core changes
  full-test-scan:
    name: Full Test & Scan
    needs: detect-changes
    if: needs.detect-changes.outputs.needs_full_test == 'true'
    uses: ./.github/workflows/reusable-test-scan.yml
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Light scan for templates/static changes
  light-scan:
    name: Light Security Scan
    needs: detect-changes
    if: needs.detect-changes.outputs.needs_light_scan == 'true'
    uses: ./.github/workflows/reusable-light-scan.yml

  # Build and deploy
  build-deploy:
    name: Build & Deploy
    needs: [detect-changes, full-test-scan, light-scan]
    if: |
      always() &&
      needs.detect-changes.outputs.needs_build == 'true' &&
      github.event_name == 'push' &&
      (needs.full-test-scan.result == 'success' || needs.full-test-scan.result == 'skipped') &&
      (needs.light-scan.result == 'success' || needs.light-scan.result == 'skipped')
    uses: ./.github/workflows/reusable-build-deploy.yml
    with:
      environment: ${{ needs.detect-changes.outputs.environment }}
      image-tag: ${{ github.sha }}
      skip-build: ${{ needs.detect-changes.outputs.skip_build == 'true' }}
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}