name: Dorashop CI/CD Pipeline

on:
  pull_request:
    branches: [main, test]
    types: [opened, synchronize, reopened]
    paths:
      - 'web/dorashop/**'
      - 'ci-cd/k8s/**'
      - 'ci-cd/sonarqube/**'
      - '.github/workflows/**'
  push:
    branches: [main, test]
    paths:
      - 'web/dorashop'        # Submodule pointer change
      - 'web/dorashop/**'     # Files inside submodule
      - 'ci-cd/k8s/**'
  workflow_dispatch:

env:
  AWS_REGION: ap-southeast-1
  ECR_REGISTRY_URL: 540649423715.dkr.ecr.ap-southeast-1.amazonaws.com
  ECR_REPOSITORY: my-web-app
  IMAGE_TAG: ${{ github.sha }}

jobs:
  # Detect which parts of the codebase changed
  path-filter:
    name: Detect Changed Paths
    runs-on: ubuntu-latest
    outputs:
      cart: ${{ steps.filter.outputs.cart || steps.submodule-check.outputs.has_submodule_change }}
      products: ${{ steps.filter.outputs.products || steps.submodule-check.outputs.has_submodule_change }}
      other: ${{ steps.filter.outputs.other || steps.submodule-check.outputs.has_submodule_change }}
      k8s: ${{ steps.filter.outputs.k8s }}
      workflows: ${{ steps.filter.outputs.workflows }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Check for submodule changes
        id: submodule-check
        run: |
          # Check if web/dorashop submodule pointer changed
          if git diff HEAD~1 HEAD --submodule=short | grep -q 'web/dorashop'; then
            echo "has_submodule_change=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Submodule web/dorashop changed - will trigger all tests"
          else
            echo "has_submodule_change=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No submodule changes detected"
          fi

      - name: Check path filters
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            cart:
              - 'web/dorashop/cart/**'
            products:
              - 'web/dorashop/products/**'
            other:
              - 'web/dorashop/dorashop/**'
              - 'web/dorashop/requirements.txt'
              - 'web/dorashop/Dockerfile'
              - 'web/dorashop/entrypoint.sh'
              - 'web/dorashop/manage.py'
              - 'web/dorashop/templates/**'
              - 'web/dorashop/static/**'
            k8s:
              - 'ci-cd/k8s/**'
            workflows:
              - '.github/workflows/**'

  # Test Cart service code
  test-cart:
    name: Test Cart Service
    runs-on: ubuntu-latest
    needs: path-filter
    # Run if cart code or shared code (other) changed
    if: |
      needs.path-filter.outputs.cart == 'true' || 
      needs.path-filter.outputs.other == 'true'
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: dorashop
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          cd web/dorashop
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-django

      - name: Run Cart Tests
        env:
          DJANGO_SETTINGS_MODULE: dorashop.settings
          PYTHONPATH: ${{ github.workspace }}/web/dorashop
          DB_ENGINE: django.db.backends.postgresql
          DB_NAME: dorashop
          DB_USER: postgres
          DB_PASSWORD: postgres
          DB_HOST: localhost
          DB_PORT: 5432
        run: |
          cd web/dorashop
          python manage.py migrate --noinput
          python manage.py collectstatic --noinput
          cd ${{ github.workspace }}
          # Run tests specific to cart app
          pytest ci-cd/sonarqube/tests/ \
            -k "cart or Cart" \
            -c ci-cd/sonarqube/pytest.ini \
            --cov=web/dorashop/cart \
            --cov-report=xml:coverage-cart.xml \
            --cov-report=term-missing

      - name: Upload Cart Coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-cart
          path: coverage-cart.xml
          retention-days: 7

  # Test Products service code
  test-products:
    name: Test Products Service
    runs-on: ubuntu-latest
    needs: path-filter
    # Run if products code or shared code (other) changed
    if: |
      needs.path-filter.outputs.products == 'true' || 
      needs.path-filter.outputs.other == 'true'
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: dorashop
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          cd web/dorashop
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-django

      - name: Run Products Tests
        env:
          DJANGO_SETTINGS_MODULE: dorashop.settings
          PYTHONPATH: ${{ github.workspace }}/web/dorashop
          DB_ENGINE: django.db.backends.postgresql
          DB_NAME: dorashop
          DB_USER: postgres
          DB_PASSWORD: postgres
          DB_HOST: localhost
          DB_PORT: 5432
        run: |
          cd web/dorashop
          python manage.py migrate --noinput
          python manage.py collectstatic --noinput
          cd ${{ github.workspace }}
          # Run tests specific to products app (comic, product tests)
          pytest ci-cd/sonarqube/tests/ \
            -k "comic or product or Comic or Product" \
            -c ci-cd/sonarqube/pytest.ini \
            --cov=web/dorashop/products \
            --cov-report=xml:coverage-products.xml \
            --cov-report=term-missing

      - name: Upload Products Coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-products
          path: coverage-products.xml
          retention-days: 7

  # Test other shared code
  test-other:
    name: Test Shared Code
    runs-on: ubuntu-latest
    needs: path-filter
    # Run if shared code changed
    if: needs.path-filter.outputs.other == 'true'
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: dorashop
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          cd web/dorashop
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-django

      - name: Run All Tests (Shared Code Changed)
        env:
          DJANGO_SETTINGS_MODULE: dorashop.settings
          PYTHONPATH: ${{ github.workspace }}/web/dorashop
          DB_ENGINE: django.db.backends.postgresql
          DB_NAME: dorashop
          DB_USER: postgres
          DB_PASSWORD: postgres
          DB_HOST: localhost
          DB_PORT: 5432
        run: |
          cd web/dorashop
          python manage.py migrate --noinput
          python manage.py collectstatic --noinput
          cd ${{ github.workspace }}
          # Run all tests when shared code changes
          pytest ci-cd/sonarqube/tests/ \
            -c ci-cd/sonarqube/pytest.ini \
            --cov=web/dorashop \
            --cov-report=xml:coverage-other.xml \
            --cov-report=term-missing

      - name: Upload Other Coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-other
          path: coverage-other.xml
          retention-days: 7

  # Security scanning
  security-scan:
    name: Security Scan
    needs: path-filter
    if: |
      needs.path-filter.outputs.cart == 'true' || 
      needs.path-filter.outputs.products == 'true' || 
      needs.path-filter.outputs.other == 'true'
    uses: ./.github/workflows/_reusable-security-scan.yml
    with:
      scan_path: 'web/dorashop'
      sonarqube_config: 'ci-cd/sonarqube/sonar-project.properties'
      trivy_severity: 'CRITICAL,HIGH,MEDIUM'
      trivy_ignore_file: 'ci-cd/trivy/.trivyignore'
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Build and push Docker image (only once)
  build-push:
    name: Build & Push Docker Image
    needs: [path-filter, test-cart, test-products, test-other, security-scan]
    # Only run on push to main/test and if any code changed
    if: |
      always() &&
      github.event_name == 'push' &&
      (needs.path-filter.outputs.cart == 'true' || 
       needs.path-filter.outputs.products == 'true' || 
       needs.path-filter.outputs.other == 'true' ||
       needs.path-filter.outputs.k8s == 'true') &&
      (needs.test-cart.result == 'success' || needs.test-cart.result == 'skipped') &&
      (needs.test-products.result == 'success' || needs.test-products.result == 'skipped') &&
      (needs.test-other.result == 'success' || needs.test-other.result == 'skipped') &&
      (needs.security-scan.result == 'success' || needs.security-scan.result == 'skipped')
    uses: ./.github/workflows/_reusable-build-push.yml
    with:
      service_name: dorashop
      dockerfile_path: web/dorashop
      context_path: web/dorashop
      ecr_repository: my-web-app
      aws_region: ap-southeast-1
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  # Update Kubernetes manifests (GitOps)
  update-manifests:
    name: Update GitOps Manifests
    needs: [path-filter, build-push]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Determine Changed Services
        id: changes
        env:
          CART: ${{ needs.path-filter.outputs.cart }}
          PRODUCTS: ${{ needs.path-filter.outputs.products }}
          OTHER: ${{ needs.path-filter.outputs.other }}
        run: |
          SERVICES=""
          [ "$CART" == "true" ] && SERVICES="${SERVICES}cart "
          [ "$PRODUCTS" == "true" ] && SERVICES="${SERVICES}products "
          [ "$OTHER" == "true" ] && SERVICES="${SERVICES}shared "
          echo "services=${SERVICES:-none}" >> $GITHUB_OUTPUT
          echo "Changed services: $SERVICES"

      - name: Update Kustomize Image
        env:
          IMAGE_TAG: ${{ needs.build-push.outputs.image_tag }}
          ENVIRONMENT: ${{ github.ref == 'refs/heads/main' && 'production' || 'dev' }}
          SERVICES: ${{ steps.changes.outputs.services }}
        run: |
          echo "üì¶ Updating $ENVIRONMENT with image tag: $IMAGE_TAG"
          echo "üîß Changed services: $SERVICES"
          
          cd ci-cd/k8s/overlays/$ENVIRONMENT
          
          # Update image tag
          kustomize edit set image dorashop-web=${{ env.ECR_REGISTRY_URL }}/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG
          
          # Configure git
          git config user.name "CI/CD Bot"
          git config user.email "ci-cd-bot@users.noreply.github.com"
          
          # Commit and push
          git add kustomization.yaml
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è  No changes to commit"
          else
            git commit -m "chore(gitops): update $ENVIRONMENT to $IMAGE_TAG [$SERVICES] [skip ci]"
            git pull --rebase
            git push
            echo "‚úÖ Manifest updated successfully"
          fi
