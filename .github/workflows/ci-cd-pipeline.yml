name: CI/CD Pipeline

on:
  repository_dispatch:
    types: [service-build]
  workflow_dispatch:
    inputs:
      changed_services:
        description: 'Services to build (cart, products, all, frontend)'
        required: true
        type: string
        default: 'all'
      change_type:
        description: 'Type of change (critical, core, service, frontend, config, normal)'
        required: false
        type: string
        default: 'normal'
      critical_files:
        description: 'Critical files changed (true/false)'
        required: false
        type: string
        default: 'false'

env:
  AWS_REGION: ap-southeast-1
  ECR_REGISTRY_URL: 540649423715.dkr.ecr.ap-southeast-1.amazonaws.com
  ECR_REPOSITORY: my-web-app
  IMAGE_TAG: ${{ github.sha }}

jobs:
  determine-services:
    name: Determine Services to Build
    runs-on: ubuntu-latest
    outputs:
      build_cart: ${{ steps.check.outputs.build_cart }}
      build_products: ${{ steps.check.outputs.build_products }}
      services_list: ${{ steps.check.outputs.services_list }}
      change_type: ${{ steps.check.outputs.change_type }}
      critical_files: ${{ steps.check.outputs.critical_files }}
    steps:
      - name: Check Services
        id: check
        run: |
          # Get services from payload or input
          if [ -n "${{ github.event.client_payload.changed_services }}" ]; then
            SERVICES="${{ github.event.client_payload.changed_services }}"
          else
            SERVICES="${{ inputs.changed_services }}"
          fi
          
          # Get change type
          if [ -n "${{ github.event.client_payload.change_type }}" ]; then
            CHANGE_TYPE="${{ github.event.client_payload.change_type }}"
          else
            CHANGE_TYPE="${{ inputs.change_type }}"
          fi
          
          # Get critical flag
          if [ -n "${{ github.event.client_payload.critical_files }}" ]; then
            CRITICAL="${{ github.event.client_payload.critical_files }}"
          else
            CRITICAL="${{ inputs.critical_files }}"
          fi
          
          echo "services_list=$SERVICES" >> $GITHUB_OUTPUT
          echo "change_type=$CHANGE_TYPE" >> $GITHUB_OUTPUT
          echo "critical_files=$CRITICAL" >> $GITHUB_OUTPUT
          
          # Determine what to build
          if [[ "$SERVICES" == *"cart"* ]] || [[ "$SERVICES" == "all" ]]; then
            echo "build_cart=true" >> $GITHUB_OUTPUT
            echo "ğŸ›’ Will build cart service"
          else
            echo "build_cart=false" >> $GITHUB_OUTPUT
            echo "âŠ˜ Skip cart service"
          fi
          
          if [[ "$SERVICES" == *"products"* ]] || [[ "$SERVICES" == "all" ]]; then
            echo "build_products=true" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Will build products service"
          else
            echo "build_products=false" >> $GITHUB_OUTPUT
            echo "âŠ˜ Skip products service"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Build Plan:"
          echo "   Services: $SERVICES"
          echo "   Type: $CHANGE_TYPE"
          echo "   Critical: $CRITICAL"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # Test Cart Service
  test-cart:
    name: Test Cart Service
    runs-on: ubuntu-latest
    needs: determine-services
    if: needs.determine-services.outputs.build_cart == 'true'
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: dorashop
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          cd web/dorashop
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-django

      - name: Run Cart Tests with Coverage
        env:
          DJANGO_SETTINGS_MODULE: dorashop.settings
          PYTHONPATH: ${{ github.workspace }}/web/dorashop
          DB_ENGINE: django.db.backends.postgresql
          DB_NAME: dorashop
          DB_USER: postgres
          DB_PASSWORD: postgres
          DB_HOST: localhost
          DB_PORT: 5432
        run: |
          cd web/dorashop
          python manage.py migrate --noinput
          python manage.py collectstatic --noinput
          cd ${{ github.workspace }}
          pytest ci-cd/sonarqube/tests/ \
            -c ci-cd/sonarqube/pytest.ini \
            --cov=web/dorashop/cart \
            --cov-report=xml:coverage-cart.xml \
            --cov-report=term-missing

      - name: Upload Cart Coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-cart
          path: coverage-cart.xml
          retention-days: 1

  # Test Products Service
  test-products:
    name: Test Products Service
    runs-on: ubuntu-latest
    needs: determine-services
    if: needs.determine-services.outputs.build_products == 'true'
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: dorashop
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          cd web/dorashop
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-django

      - name: Run Products Tests with Coverage
        env:
          DJANGO_SETTINGS_MODULE: dorashop.settings
          PYTHONPATH: ${{ github.workspace }}/web/dorashop
          DB_ENGINE: django.db.backends.postgresql
          DB_NAME: dorashop
          DB_USER: postgres
          DB_PASSWORD: postgres
          DB_HOST: localhost
          DB_PORT: 5432
        run: |
          cd web/dorashop
          python manage.py migrate --noinput
          python manage.py collectstatic --noinput
          cd ${{ github.workspace }}
          pytest ci-cd/sonarqube/tests/ \
            -c ci-cd/sonarqube/pytest.ini \
            --cov=web/dorashop/products \
            --cov-report=xml:coverage-products.xml \
            --cov-report=term-missing

      - name: Upload Products Coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-products
          path: coverage-products.xml
          retention-days: 1

  # Security Scan (sá»­ dá»¥ng reusable workflow)
  security-scan:
    name: Security Scan
    needs: [determine-services, test-cart, test-products]
    if: |
      always() &&
      (needs.test-cart.result == 'success' || needs.test-cart.result == 'skipped') &&
      (needs.test-products.result == 'success' || needs.test-products.result == 'skipped')
    uses: ./.github/workflows/_reusable-security-scan.yml
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Build & Push Image (chá»‰ 1 image vÃ¬ monolith)
  build-push:
    name: Build & Push Image
    needs: [determine-services, test-cart, test-products, security-scan]
    if: |
      (needs.test-cart.result == 'success' || needs.test-cart.result == 'skipped') &&
      (needs.test-products.result == 'success' || needs.test-products.result == 'skipped') &&
      needs.security-scan.result == 'success'
    uses: ./.github/workflows/_reusable-build-push.yml
    with:
      service_name: dorashop
      dockerfile_path: web/dorashop
      context_path: web/dorashop
      ecr_repository: my-web-app
      aws_region: ap-southeast-1
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  # Update GitOps Manifests
  update-manifests:
    name: Update GitOps Manifests
    needs: [determine-services, build-push]
    if: needs.build-push.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Update Kustomize Image
        env:
          IMAGE_TAG: ${{ needs.build-push.outputs.image_tag }}
          ENVIRONMENT: dev
          SERVICES: ${{ needs.determine-services.outputs.services_list }}
        run: |
          echo "ğŸ“¦ Updating $ENVIRONMENT with services: $SERVICES"
          echo "ğŸ“¦ Image tag: $IMAGE_TAG"
          
          cd ci-cd/k8s/overlays/$ENVIRONMENT
          
          # Update image tag
          kustomize edit set image dorashop-web=${{ env.ECR_REGISTRY_URL }}/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG
          
          # Configure git
          git config user.name "CI/CD Bot"
          git config user.email "ci-cd-bot@users.noreply.github.com"
          
          # Commit and push
          git add kustomization.yaml
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸  No changes to commit"
          else
            git commit -m "chore(gitops): update $ENVIRONMENT [$SERVICES] to $IMAGE_TAG [skip ci]"
            git pull --rebase
            git push
            echo "âœ… Manifest updated successfully"
          fi

  # Summary Job
  summary:
    name: Deployment Summary
    needs: [determine-services, test-cart, test-products, security-scan, build-push, update-manifests]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Display Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š SERVICE-SPECIFIC CI/CD SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ¯ Services: ${{ needs.determine-services.outputs.services_list }}"
          echo "ğŸ”§ Type: ${{ needs.determine-services.outputs.change_type }}"
          echo "ğŸ”´ Critical: ${{ needs.determine-services.outputs.critical_files }}"
          echo ""
          echo "ğŸ“‹ Job Results:"
          echo "â”œâ”€ Cart Test: ${{ needs.test-cart.result }}"
          echo "â”œâ”€ Products Test: ${{ needs.test-products.result }}"
          echo "â”œâ”€ Security Scan: ${{ needs.security-scan.result }}"
          echo "â”œâ”€ Build & Push: ${{ needs.build-push.result }}"
          echo "â””â”€ Update Manifests: ${{ needs.update-manifests.result }}"
          echo ""
          
          # Overall status
          if [[ "${{ needs.update-manifests.result }}" == "success" ]]; then
            echo "âœ… DEPLOYMENT SUCCESSFUL"
            echo "ğŸš€ Changes will be deployed by ArgoCD"
          elif [[ "${{ needs.build-push.result }}" == "success" ]]; then
            echo "âœ… BUILD SUCCESSFUL"
            echo "âš ï¸  Manifest update failed or skipped"
          else
            echo "âŒ DEPLOYMENT FAILED"
            echo "ğŸ” Check logs above for details"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
